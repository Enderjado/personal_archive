# Phase 2: PDF Import Pipeline (Implementation Specification)

This document defines the public Phase 2 implementation specification for the PDF input pipeline. It is the canonical reference for implementers and reviewers who do not have access to private preparation material.

It complements the high-level pipeline in `pipeline.md` and aligns with `architecture.md`, `data_model.md`, and `storage_conventions.md`.

---

## Objectives

Phase 2 establishes a reliable import foundation that:

1. accepts a user-selected PDF,
2. validates it before persistence,
3. stores it in app-managed file storage,
4. creates `Document` and `Page` records with initial status `imported`.

The output of this phase is a correctly imported, internally tracked document ready for downstream processing stages.

---

## Scope

### In Scope

- PDF import contract and orchestration responsibilities.
- Input validation requirements before copy and database writes.
- File storage strategy for imported PDFs.
- Initial persistence flow for `Document` and `Page` entities.
- Error handling and cleanup semantics for import failures.

### Out of Scope

- OCR execution and OCR quality handling.
- LLM summarization, keyword extraction, and place classification.
- UI/UX behavior beyond initiating import.
- Search ranking and retrieval behavior beyond required import sync points.

---

## Terminology

- **Import source path**: Original user-selected file location.
- **Managed PDF path**: Destination path controlled by application storage conventions.
- **Validation error**: Rejection before file copy or DB writes.
- **Import failure**: Failure during copy or persistence after validation succeeds.

---

## File Storage Strategy

Imported PDFs are persisted in application-managed storage so document processing is independent from the original user-selected file location. Detailed architectural decisions are documented in [docs/decisions/0012-file-storage-strategy-for-imported-pdfs.md](docs/decisions/0012-file-storage-strategy-for-imported-pdfs.md).

### Storage Root

- The storage root is configurable through application configuration (local-first, no remote dependency).
- The root path must resolve to a writable app-managed directory.
- Import logic must treat the configured root as the single authoritative base for managed PDF files.

### Naming and Layout

- Managed file path format: `<storageRoot>/<documentId>.pdf`.
- `documentId` is the canonical identifier generated by the application layer.
- The managed PDF path is deterministic and stable for the lifecycle of the document.
- The persisted `Document.filePath` points to the managed path, not the original source path.

### Copy vs Move Policy

- Phase 2 uses **copy**, not move.
- The original source file is never mutated, renamed, or deleted by import logic.
- Rationale:
  - preserves user expectations for source files,
  - avoids cross-volume move edge cases,
  - keeps import behavior consistent and reversible.

### Failure Cleanup Semantics

- If validation fails, no file is copied and no database rows are created.
- If file copy fails, no database rows are created.
- If a failure occurs after the file has been copied but before import persistence completes, the copied managed file is deleted as part of rollback.
- Cleanup intent: no orphan managed files and no half-imported document state when the pipeline follows this contract.

---

## Validation Contract

Validation is a strict precondition stage for import. No managed-file copy and no database write is allowed before validation succeeds.

### Validation Order

Validation executes in this order:

1. **Exists**: source path resolves to an existing file.
2. **Readable**: source file can be opened for read.
3. **PDF type**: file is recognized as PDF (extension check is not sufficient on its own).
4. **File size limit**: file size must be less than or equal to configured max import size.
5. **Page count limit**: detected page count must be less than or equal to configured max pages.

Validation stops on first failure and returns a typed validation result.

### Default Limits

- `maxImportFileSizeBytes`: configurable, default **50 MiB**.
- `maxImportPageCount`: configurable, default **500 pages**.

These defaults are safety baselines and may be tuned via application configuration without changing the pipeline contract.

### Validation Error Representation

Validation failures are represented as domain-level validation errors, distinct from storage/runtime failures.

Minimum error categories:

- `sourceNotFound`
- `sourceNotReadable`
- `unsupportedFileType`
- `fileTooLarge`
- `pageCountExceeded`

Each validation error includes:

- stable error code,
- human-readable message suitable for UI translation mapping,
- optional structured metadata (for example: actual file size, configured limit, detected page count).

### Contract Guarantees

- Validation failures produce no side effects in managed storage or persistence.
- Validation error handling is deterministic and testable in isolation.
- Validation and limit values are configuration-driven, with documented defaults.

---

## Import Pipeline Sequence

Phase 2 import follows this ordered flow:

1. **Validate input**
   - Apply the validation contract against the source path.
   - Abort immediately on validation error.
2. **Copy to managed storage**
   - Generate `documentId`.
   - Derive managed target path `<storageRoot>/<documentId>.pdf`.
   - Copy source PDF to managed storage.
3. **Create document record**
   - Persist `Document` with status `imported` and managed `filePath`.
4. **Read PDF metadata**
   - Read page count from the managed PDF.
5. **Create page records**
   - Create ordered `Page` rows (`1..pageCount`) linked to `documentId`.
6. **Sync search index state (FTS boundary)**
   - Trigger required import-time synchronization so the storage/search layer stays internally consistent with created entities.

### Sequence Guarantees

- Step order is strict and deterministic.
- A later step must not run when a prior step fails.
- On failure after file copy, rollback cleanup removes copied managed files and prevents half-imported persistence.

---

## Interface Responsibilities

Phase 2 separates orchestration from file I/O, PDF metadata access, and persistence.

### `DocumentPipeline`

Orchestrates the full import use case and owns step ordering, error mapping, and cleanup coordination.

Responsibilities:

- call validation,
- coordinate managed-file copy,
- persist `Document` and `Page` entities via repositories,
- trigger required import-time sync boundaries,
- enforce rollback/cleanup semantics.

`DocumentPipeline` does not implement low-level file operations or PDF parsing directly.

### `DocumentFileStorage`

Abstracts managed file operations for imported PDFs.

Responsibilities:

- resolve storage root,
- derive deterministic managed path from `documentId`,
- copy source files into managed storage,
- delete managed files during rollback/cleanup.

### `PdfMetadataReader`

Abstracts PDF metadata access used during import. The choice of underlying PDF library is documented in [docs/decisions/0013-pdf-library-choice-for-metadata.md](docs/decisions/0013-pdf-library-choice-for-metadata.md).

Responsibilities:

- read page-count metadata from a managed PDF path,
- surface typed metadata/read failures to the pipeline.

### Repository Collaboration Boundaries

- `DocumentPipeline` writes `Document` through `DocumentRepository`.
- `DocumentPipeline` writes ordered `Page` rows through `PageRepository`.
- Repository interfaces remain persistence-focused; orchestration logic stays in `DocumentPipeline`.

---

## Cross-Link and Consistency Status

This public Phase 2 specification is cross-linked with:

- `pipeline.md` (high-level import stage context),
- `architecture.md` (layer boundaries and pipeline orchestration placement),
- `data_model.md` (Document/Page semantics used during import),
- `storage_conventions.md` (SQLite conventions and FTS sync boundary),
- `decisions/0012-file-storage-strategy-for-imported-pdfs.md`,
- `decisions/0013-pdf-library-choice-for-metadata.md`.

Consistency note: no intentional deviation from the private preparation specification is introduced in this public Phase 2 documentation set. If implementation later changes naming or behavior, this document and linked ADRs must be updated and treated as source of truth.

---

## Related Documents

- `pipeline.md` (high-level end-to-end pipeline)
- `architecture.md` (layer boundaries and responsibilities)
- `data_model.md` (entity semantics for `Document` and `Page`)
- `storage_conventions.md` (SQLite and storage conventions)
- `decisions/0012-file-storage-strategy-for-imported-pdfs.md` (ADR for managed PDF storage layout and cleanup)
- `decisions/0013-pdf-library-choice-for-metadata.md` (ADR for page-count metadata library selection)
- `decisions/` (ADRs for file storage strategy and PDF metadata library choice)
