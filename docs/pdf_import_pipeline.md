# Phase 2: PDF Import Pipeline (Implementation Specification)

This document defines the public Phase 2 implementation specification for the PDF input pipeline. It is the canonical reference for implementers and reviewers who do not have access to private preparation material.

It complements the high-level pipeline in `pipeline.md` and aligns with `architecture.md`, `data_model.md`, and `storage_conventions.md`.

---

## Objectives

Phase 2 establishes a reliable import foundation that:

1. accepts a user-selected PDF,
2. validates it before persistence,
3. stores it in app-managed file storage,
4. creates `Document` and `Page` records with initial status `imported`.

The output of this phase is a correctly imported, internally tracked document ready for downstream processing stages.

---

## Scope

### In Scope

- PDF import contract and orchestration responsibilities.
- Input validation requirements before copy and database writes.
- File storage strategy for imported PDFs.
- Initial persistence flow for `Document` and `Page` entities.
- Error handling and cleanup semantics for import failures.

### Out of Scope

- OCR execution and OCR quality handling.
- LLM summarization, keyword extraction, and place classification.
- UI/UX behavior beyond initiating import.
- Search ranking and retrieval behavior beyond required import sync points.

---

## Terminology

- **Import source path**: Original user-selected file location.
- **Managed PDF path**: Destination path controlled by application storage conventions.
- **Validation error**: Rejection before file copy or DB writes.
- **Import failure**: Failure during copy or persistence after validation succeeds.

---

## File Storage Strategy

Imported PDFs are persisted in application-managed storage so document processing is independent from the original user-selected file location.

### Storage Root

- The storage root is configurable through application configuration (local-first, no remote dependency).
- The root path must resolve to a writable app-managed directory.
- Import logic must treat the configured root as the single authoritative base for managed PDF files.

### Naming and Layout

- Managed file path format: `<storageRoot>/<documentId>.pdf`.
- `documentId` is the canonical identifier generated by the application layer.
- The managed PDF path is deterministic and stable for the lifecycle of the document.
- The persisted `Document.filePath` points to the managed path, not the original source path.

### Copy vs Move Policy

- Phase 2 uses **copy**, not move.
- The original source file is never mutated, renamed, or deleted by import logic.
- Rationale:
  - preserves user expectations for source files,
  - avoids cross-volume move edge cases,
  - keeps import behavior consistent and reversible.

### Failure Cleanup Semantics

- If validation fails, no file is copied and no database rows are created.
- If file copy fails, no database rows are created.
- If a failure occurs after the file has been copied but before import persistence completes, the copied managed file is deleted as part of rollback.
- Cleanup intent: no orphan managed files and no half-imported document state when the pipeline follows this contract.

---

## Phase 2 Sections (Detailed in Subsequent Commits)

The following sections remain to be fully specified in follow-up commits:

1. Validation rules and error representation.
2. Ordered pipeline sequence and side-effect boundaries.
3. Interface contracts (`DocumentPipeline`, `DocumentFileStorage`, `PdfMetadataReader`).
4. Cross-links to ADRs for discrete architecture decisions.

---

## Related Documents

- `pipeline.md` (high-level end-to-end pipeline)
- `architecture.md` (layer boundaries and responsibilities)
- `data_model.md` (entity semantics for `Document` and `Page`)
- `storage_conventions.md` (SQLite and storage conventions)
- `decisions/` (ADRs for file storage strategy and PDF metadata library choice)
